# Melody Engine

---

### Step 1: The Sampler Core (Voice Logic)

*Goal: Build the engine that plays audio at different pitches.*

> Prompt Context:
> 
> 
> "I am building the MelodyEngine VST3. I need you to implement the Sampler Voice logic in Source/HouseSampler.h and .cpp.
> 
> **1. Class `HouseSynthSound`**
> 
> - Inherit from `juce::SynthesiserSound`.
> - **Member:** `juce::AudioBuffer<float> sampleData`.
> - **Member:** `double rootFrequency` (default 261.63 Hz for Middle C).
> - **Role:** Holds the read-only audio data for the chord/stab.
> - **Method:** `appliesToNote()` should return true for all MIDI notes.
> 
> **2. Class `HouseSynthVoice`**
> 
> - Inherit from `juce::SynthesiserVoice`.
> - **Members:**
>     - `double currentSamplePos` (floating point for sub-sample precision).
>     - `double pitchRatio`.
>     - `juce::ADSR adsr`.
> - **Method `startNote()`:**
>     - Calculate `pitchRatio = midiFrequency / sound->rootFrequency`.
>     - Reset `currentSamplePos = 0.0`.
>     - Trigger `adsr.noteOn()`.
> - **Method `renderNextBlock()` (The Critical Loop):**
>     - Loop through the output buffer.
>     - **Interpolation:** Implement Linear Interpolation to read from `sampleData` at `currentSamplePos`.
>         - $y = y_0 + (y_1 - y_0) \times (pos - \lfloor pos \rfloor)$
>     - Increment: `currentSamplePos += pitchRatio`.
>     - Apply ADSR envelope gain.
>     - **Stop Condition:** If `currentSamplePos` exceeds sample length OR ADSR is inactive, call `clearCurrentNote()`."

---

### Step 2: The Processor & Parameters

*Goal: Manage the voices and define the user controls.*

> Prompt Context:
> 
> 
> "Now implement the PluginProcessor logic for MelodyEngine.
> 
> **1. Parameter Layout (APVTS)**
> 
> - Create the following parameters:
>     - `ATTACK`, `DECAY`, `SUSTAIN`, `RELEASE` (ADSR).
>     - `DELAY_TIME` (Enum: 1/4, 1/8, 1/16, 1/16T).
>     - `DELAY_FEEDBACK` (Float 0.0 - 0.95).
>     - `DELAY_MIX` (Float 0.0 - 1.0).
> 
> **2. Audio Engine Setup**
> 
> - **Member:** `juce::Synthesiser synth`.
> - **Setup:** In `prepareToPlay`:
>     - Add 8 instances of `HouseSynthVoice`.
>     - Add 1 instance of `HouseSynthSound`.
>     - Load a default 'sawtooth' or 'piano' sample into the sound programmatically so the plugin isn't silent on first load.
> 
> **3. Process Block**
> 
> - Clear buffer.
> - Update ADSR parameters in the voices.
> - Call `synth.renderNextBlock(buffer, midiMessages, ...)`."

---

### Step 3: The BPM-Synced Delay (FX Chain)

*Goal: The "House" atmosphere. This requires a circular buffer.*

> Prompt Context:
> 
> 
> "Finally, implement the Stereo Delay effect inside PluginProcessor.cpp (or a separate class).
> 
> **1. Circular Buffer Logic**
> 
> - **Member:** `juce::AudioBuffer<float> delayBuffer` (Size: 2 seconds at 48kHz).
> - **Member:** `int writePosition`.
> 
> **2. BPM Calculation (`processBlock`)**
> 
> - Get BPM from `getPlayHead()->getPosition()->getBpm()`. Default to 120.0 if unavailable.
> - Calculate `samplesPerBeat = (60.0 / bpm) * sampleRate`.
> - Calculate `delaySamples` based on the `DELAY_TIME` enum (e.g., if '1/8th', then `0.5 * samplesPerBeat`).
> 
> **3. The Delay Algorithm**
> 
> - For each sample in the main buffer:
>     - Read from `delayBuffer` at `(writePosition - delaySamples + bufferSize) % bufferSize`.
>     - **Feedback:** `newDelaySample = input + (delayedSample * feedback)`.
>     - Write `newDelaySample` into `delayBuffer` at `writePosition`.
>     - **Output:** `output = (input * (1-mix)) + (delayedSample * mix)`.
>     - Increment and wrap `writePosition`."

### Execution Order

1. **Feed Step 1 first.** Verify it compiles and you can hear a basic sound (even if it's raw).
2. **Feed Step 2.** Verify you can control the envelope (Attack/Release).
3. **Feed Step 3.** Verify the echoes sync to your DAW's tempo.

**Correction on Step 3:** Standard circular buffers require careful pointer arithmetic to avoid clicks when the delay time changes.

- **Engineering Note:** Tell the agent to use `juce::SmoothedValue<float>` for the delay time if you want to perform pitch-warping effects when turning the knob (tape delay style), OR use a cross-fade if you want clean jumps. For House music, **tape-style pitch warping** is preferred.

Do you want me to add the logic for "Tape Style" smoothing to the prompt, or keep it simple?